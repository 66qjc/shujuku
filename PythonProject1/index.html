<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>首页 - 商品列表</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
    <h2>商品列表</h2>
    <a href="login.html" class="btn btn-outline-secondary mb-2" onclick="logout(); return false;">退出登录</a>
    <a href="publish.html" class="btn btn-success mb-2 ms-2">发布商品</a>
    <a href="chart.html" class="btn btn-info mb-2 ms-2">数据可视化</a>

    <!-- 筛选区 -->
    <div class="row mb-3">
        <div class="col-md-3">
            <select id="category" class="form-select">
                <option value="">全部类别</option>
                <option value="1">书籍</option>
                <option value="2">电子产品</option>
                <option value="3">生活用品</option>
            </select>
        </div>
        <div class="col-md-2">
            <input type="number" id="min_price" class="form-control" placeholder="最低价">
        </div>
        <div class="col-md-2">
            <input type="number" id="max_price" class="form-control" placeholder="最高价">
        </div>
        <div class="col-md-2">
            <button onclick="loadProducts()" class="btn btn-primary">筛选</button>
        </div>
    </div>

    <!-- 商品表格 -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>商品名</th>
                <th>价格</th>
                <th>类别</th>
                <th>卖家</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="product-list"></tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="common.js"></script>
<script>
// 页面加载后执行
document.addEventListener('DOMContentLoaded', function() {
    checkLogin();  // 检查登录状态
    loadProducts(); // 初次加载商品列表
});

function loadProducts() {
    console.log('开始加载商品...');

    const cat = document.getElementById('category').value || '';
    const min = document.getElementById('min_price').value || '';
    const max = document.getElementById('max_price').value || '';

    console.log('筛选条件:', { category_id: cat, min_price: min, max_price: max });

    // 临时：使用完整URL测试，绕过api封装
    let url = 'http://localhost:5000/product_list?';
    if (cat) url += `category_id=${cat}&`;
    if (min) url += `min_price=${min}&`;
    if (max) url += `max_price=${max}`;

    console.log('请求URL:', url);

    // 直接使用axios测试
    axios.get(url)
        .then(res => {
            console.log('请求成功:', res.data);
            const list = document.getElementById('product-list');
            list.innerHTML = '';

            if (res.data && res.data.products && res.data.products.length > 0) {
                res.data.products.forEach(p => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${p.product_name || '未命名商品'}</td>
                        <td>¥${p.price || 0}</td>
                        <td>${p.category_name || '未分类'}</td>
                        <td>${p.seller_name || '未知卖家'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="buy(${p.product_id})">购买</button>
                            <button class="btn btn-sm btn-outline-warning" onclick="collect(${p.product_id})">收藏</button>
                        </td>
                    `;
                    list.appendChild(row);
                });
            } else {
                list.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">暂无商品数据</td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('请求失败详情:', error);
            console.error('错误响应:', error.response);
            const list = document.getElementById('product-list');
            list.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        加载失败: ${error.message || '未知错误'}
                        <br>
                        <small>状态码: ${error.response?.status || '无响应'}</small>
                        <br>
                        <button onclick="loadProducts()" class="btn btn-sm btn-primary mt-2">重试</button>
                    </td>
                </tr>
            `;
        });
}

function collect(pid) {
    if (!checkLogin()) return;

    const uid = getUserId();
    if (!uid) {
        showMessage('无法获取用户ID，请重新登录', 'error');
        return;
    }

    api.post('toggle_favorite', {
        user_id: uid,
        product_id: pid,
        type: 'collect'
    })
    .then(res => {
        const action = res.action || '收藏';
        showMessage(`已${action}`, 'success');
    })
    .catch(error => {
        showMessage('操作失败：' + (error.response?.data?.message || '未知错误'), 'error');
    });
}
</script>
</body>
</html>