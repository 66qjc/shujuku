<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ•°æ®å¯è§†åŒ– - æ ¡å›­äºŒæ‰‹äº¤æ˜“å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card {
            transition: transform 0.3s;
            height: 100%;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }
        .stat-card {
            border-radius: 10px;
            overflow: hidden;
        }
        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .refresh-btn {
            cursor: pointer;
            transition: transform 0.3s;
        }
        .refresh-btn:hover {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
<div class="container-fluid py-4">
    <!-- é¡µé¢æ ‡é¢˜å’Œå¯¼èˆª -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">ğŸ“Š æ•°æ®å¯è§†åŒ–çœ‹æ¿</h2>
                    <p class="text-muted mb-0">å®æ—¶å±•ç¤ºå¹³å°äº¤æ˜“æ•°æ®ä¸ç»Ÿè®¡åˆ†æ</p>
                </div>
                <div>
                    <a href="index.html" class="btn btn-outline-primary">
                        â† è¿”å›å•†å“åˆ—è¡¨
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stat-card border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">åœ¨å”®å•†å“</h6>
                            <h3 class="mb-0" id="activeProducts">--</h3>
                            <p class="text-success mb-0 small">
                                <span id="productChange">+0</span> ä»Šæ—¥
                            </p>
                        </div>
                        <div class="stat-icon text-primary">
                            ğŸ“¦
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card stat-card border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">æˆäº¤è®¢å•</h6>
                            <h3 class="mb-0" id="totalOrders">--</h3>
                            <p class="text-success mb-0 small">
                                <span id="orderChange">+0</span> ä»Šæ—¥
                            </p>
                        </div>
                        <div class="stat-icon text-success">
                            ğŸ’°
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card stat-card border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">ç”¨æˆ·æ”¶è—</h6>
                            <h3 class="mb-0" id="totalFavorites">--</h3>
                            <p class="text-success mb-0 small">
                                <span id="favoriteChange">+0</span> ä»Šæ—¥
                            </p>
                        </div>
                        <div class="stat-icon text-info">
                            â­
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card stat-card border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">æ´»è·ƒç”¨æˆ·</h6>
                            <h3 class="mb-0" id="activeUsers">--</h3>
                            <p class="text-success mb-0 small">
                                <span id="userChange">+0</span> ä»Šæ—¥
                            </p>
                        </div>
                        <div class="stat-icon text-warning">
                            ğŸ‘¥
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="row mb-4">
        <!-- å•†å“ç±»åˆ«åˆ†å¸ƒ -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ“š å•†å“ç±»åˆ«åˆ†å¸ƒ</h5>
                    <button class="btn btn-sm btn-outline-secondary refresh-btn"
                            onclick="loadCategoryChart()" title="åˆ·æ–°">
                        â†»
                    </button>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <p class="text-muted small mb-0">å±•ç¤ºå„ç±»åˆ«å•†å“æ•°é‡å æ¯”</p>
                </div>
            </div>
        </div>

        <!-- ä»·æ ¼åˆ†å¸ƒ -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ’° ä»·æ ¼åŒºé—´åˆ†å¸ƒ</h5>
                    <button class="btn btn-sm btn-outline-secondary refresh-btn"
                            onclick="loadPriceChart()" title="åˆ·æ–°">
                        â†»
                    </button>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <p class="text-muted small mb-0">ä¸åŒä»·æ ¼åŒºé—´çš„å•†å“æ•°é‡</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ›´å¤šå›¾è¡¨ -->
    <div class="row mb-4">
        <!-- æ¯æœˆäº¤æ˜“è¶‹åŠ¿ -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ“ˆ äº¤æ˜“è¶‹åŠ¿åˆ†æ</h5>
                    <div>
                        <select class="form-select form-select-sm w-auto d-inline"
                                id="trendType" onchange="loadTrendChart()">
                            <option value="monthly">æœˆåº¦è¶‹åŠ¿</option>
                            <option value="weekly">å‘¨åº¦è¶‹åŠ¿</option>
                        </select>
                        <button class="btn btn-sm btn-outline-secondary refresh-btn ms-2"
                                onclick="loadTrendChart()" title="åˆ·æ–°">
                            â†»
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                    <p class="text-muted small mb-0">å±•ç¤ºå¹³å°äº¤æ˜“é‡å˜åŒ–è¶‹åŠ¿</p>
                </div>
            </div>
        </div>

        <!-- çƒ­é—¨å•†å“ -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ”¥ çƒ­é—¨å•†å“ Top 5</h5>
                </div>
                <div class="card-body">
                    <div id="hotProducts" class="list-group list-group-flush">
                        <!-- åŠ¨æ€åŠ è½½çƒ­é—¨å•†å“ -->
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="me-3 text-primary">ğŸ”¥</div>
                                <div>
                                    <div class="fw-medium">Pythonç¼–ç¨‹ä»å…¥é—¨åˆ°å®è·µ</div>
                                    <small class="text-muted">æ”¶è—: 15æ¬¡</small>
                                </div>
                            </div>
                            <span class="badge bg-primary rounded-pill">Â¥68.5</span>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="loadHotProducts()">
                            æŸ¥çœ‹æ›´å¤š
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®æ›´æ–°æ—¶é—´ -->
    <div class="row">
        <div class="col">
            <div class="text-center text-muted">
                <small>æ•°æ®æœ€åæ›´æ–°æ—¶é—´: <span id="updateTime">--</span></small>
                <button class="btn btn-sm btn-outline-secondary ms-3" onclick="refreshAll()">
                    <span id="refreshIcon">â†»</span> åˆ·æ–°å…¨éƒ¨æ•°æ®
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="common.js"></script>
<script>
// å…¨å±€å›¾è¡¨å®ä¾‹
let categoryChartInstance = null;
let priceChartInstance = null;
let trendChartInstance = null;

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!checkLogin()) {
        return;
    }

    // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨å’Œæ•°æ®
    initDashboard();

    // è®¾ç½®è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯5åˆ†é’Ÿï¼‰
    setInterval(refreshAll, 5 * 60 * 1000);
});

// åˆå§‹åŒ–ä»ªè¡¨æ¿
function initDashboard() {
    // æ›´æ–°æ•°æ®æ—¶é—´
    updateDataTime();

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    loadStatistics();

    // åŠ è½½æ‰€æœ‰å›¾è¡¨
    loadCategoryChart();
    loadPriceChart();
    loadTrendChart();
    loadHotProducts();
}

// æ›´æ–°æ•°æ®æ—¶é—´
function updateDataTime() {
    const now = new Date();
    const timeStr = now.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    document.getElementById('updateTime').textContent = timeStr;
}

// åŠ è½½ç»Ÿè®¡æ•°æ®
function loadStatistics() {
    // è¿™é‡Œåº”è¯¥è°ƒç”¨APIè·å–ç»Ÿè®¡æ•°æ®
    // ç”±äºå¯èƒ½æ²¡æœ‰ä¸“é—¨çš„ç»Ÿè®¡APIï¼Œæˆ‘ä»¬ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®

    // æ¨¡æ‹Ÿæ•°æ®
    const stats = {
        activeProducts: Math.floor(Math.random() * 100) + 50,
        totalOrders: Math.floor(Math.random() * 200) + 100,
        totalFavorites: Math.floor(Math.random() * 300) + 200,
        activeUsers: Math.floor(Math.random() * 50) + 30,
        productChange: Math.floor(Math.random() * 10) + 1,
        orderChange: Math.floor(Math.random() * 5) + 1,
        favoriteChange: Math.floor(Math.random() * 15) + 5,
        userChange: Math.floor(Math.random() * 3) + 1
    };

    // æ›´æ–°DOM
    document.getElementById('activeProducts').textContent = stats.activeProducts;
    document.getElementById('totalOrders').textContent = stats.totalOrders;
    document.getElementById('totalFavorites').textContent = stats.totalFavorites;
    document.getElementById('activeUsers').textContent = stats.activeUsers;
    document.getElementById('productChange').textContent = `+${stats.productChange}`;
    document.getElementById('orderChange').textContent = `+${stats.orderChange}`;
    document.getElementById('favoriteChange').textContent = `+${stats.favoriteChange}`;
    document.getElementById('userChange').textContent = `+${stats.userChange}`;
}

// åŠ è½½å•†å“ç±»åˆ«å›¾è¡¨
function loadCategoryChart() {
    // è°ƒç”¨APIè·å–æ•°æ®
    api.get('hot_categories')
        .then(data => {
            renderCategoryChart(data.categories || [], data.counts || []);
        })
        .catch(error => {
            console.error('åŠ è½½ç±»åˆ«å›¾è¡¨å¤±è´¥:', error);
            // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            const categories = ['ä¹¦ç±', 'ç”µå­äº§å“', 'ç”Ÿæ´»ç”¨å“', 'æœé¥°', 'å…¶ä»–'];
            const counts = [25, 18, 12, 8, 5];
            renderCategoryChart(categories, counts);
        });
}

// æ¸²æŸ“å•†å“ç±»åˆ«å›¾è¡¨
function renderCategoryChart(categories, counts) {
    const ctx = document.getElementById('categoryChart').getContext('2d');

    // é”€æ¯æ—§çš„å›¾è¡¨å®ä¾‹
    if (categoryChartInstance) {
        categoryChartInstance.destroy();
    }

    // é¢œè‰²é…ç½®
    const backgroundColors = [
        'rgba(54, 162, 235, 0.7)',
        'rgba(255, 99, 132, 0.7)',
        'rgba(75, 192, 192, 0.7)',
        'rgba(255, 206, 86, 0.7)',
        'rgba(153, 102, 255, 0.7)',
        'rgba(255, 159, 64, 0.7)'
    ];

    const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));

    // åˆ›å»ºæ–°å›¾è¡¨
    categoryChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categories,
            datasets: [{
                data: counts,
                backgroundColor: backgroundColors.slice(0, categories.length),
                borderColor: borderColors.slice(0, categories.length),
                borderWidth: 1,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// åŠ è½½ä»·æ ¼åˆ†å¸ƒå›¾è¡¨
function loadPriceChart() {
    // è°ƒç”¨APIè·å–æ•°æ®
    api.get('price_distribution')
        .then(data => {
            renderPriceChart(data.price_ranges || [], data.counts || []);
        })
        .catch(error => {
            console.error('åŠ è½½ä»·æ ¼å›¾è¡¨å¤±è´¥:', error);
            // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            const priceRanges = ['0-50å…ƒ', '51-100å…ƒ', '101-200å…ƒ', '201-500å…ƒ', '501å…ƒä»¥ä¸Š'];
            const counts = [35, 28, 18, 12, 7];
            renderPriceChart(priceRanges, counts);
        });
}

// æ¸²æŸ“ä»·æ ¼åˆ†å¸ƒå›¾è¡¨
function renderPriceChart(priceRanges, counts) {
    const ctx = document.getElementById('priceChart').getContext('2d');

    // é”€æ¯æ—§çš„å›¾è¡¨å®ä¾‹
    if (priceChartInstance) {
        priceChartInstance.destroy();
    }

    // åˆ›å»ºæ–°å›¾è¡¨
    priceChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: priceRanges,
            datasets: [{
                label: 'å•†å“æ•°é‡',
                data: counts,
                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'å•†å“æ•°é‡'
                    },
                    ticks: {
                        stepSize: 5
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'ä»·æ ¼åŒºé—´'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `æ•°é‡: ${context.raw}`;
                        }
                    }
                }
            }
        }
    });
}

// åŠ è½½è¶‹åŠ¿å›¾è¡¨
function loadTrendChart() {
    const trendType = document.getElementById('trendType').value;

    // æ¨¡æ‹Ÿæ•°æ®
    let labels, data;
    if (trendType === 'monthly') {
        labels = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
        data = [12, 19, 15, 25, 22, 30, 35, 40, 38, 45, 50, 48];
    } else {
        labels = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
        data = [8, 12, 10, 15, 18, 22, 20];
    }

    renderTrendChart(labels, data, trendType === 'monthly' ? 'æœˆåº¦' : 'å‘¨åº¦');
}

// æ¸²æŸ“è¶‹åŠ¿å›¾è¡¨
function renderTrendChart(labels, data, title) {
    const ctx = document.getElementById('trendChart').getContext('2d');

    // é”€æ¯æ—§çš„å›¾è¡¨å®ä¾‹
    if (trendChartInstance) {
        trendChartInstance.destroy();
    }

    // åˆ›å»ºæ–°å›¾è¡¨
    trendChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'äº¤æ˜“é‡',
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'äº¤æ˜“é‡ï¼ˆç¬”ï¼‰'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: title
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });
}

// åŠ è½½çƒ­é—¨å•†å“
function loadHotProducts() {
    // è¿™é‡Œåº”è¯¥è°ƒç”¨APIè·å–çƒ­é—¨å•†å“
    // æ¨¡æ‹Ÿæ•°æ®
    const hotProducts = [
        { name: 'Pythonç¼–ç¨‹ä»å…¥é—¨åˆ°å®è·µ', price: 68.5, favorites: 15 },
        { name: 'äºŒæ‰‹iPhone 12', price: 2999, favorites: 12 },
        { name: 'Javaæ ¸å¿ƒæŠ€æœ¯', price: 89, favorites: 10 },
        { name: 'å°ç±³å……ç”µå®', price: 79, favorites: 8 },
        { name: 'æ•°æ®ç»“æ„ä¸ç®—æ³•', price: 45, favorites: 7 }
    ];

    const container = document.getElementById('hotProducts');
    container.innerHTML = '';

    hotProducts.forEach((product, index) => {
        const rankEmoji = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'][index];
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `
            <div class="d-flex align-items-center" style="width: 100%;">
                <div class="me-3" style="width: 30px; text-align: center; font-size: 1.2rem;">
                    ${rankEmoji}
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="fw-medium text-truncate">${product.name}</div>
                    <small class="text-muted">æ”¶è—: ${product.favorites}æ¬¡</small>
                </div>
                <span class="badge bg-primary rounded-pill ms-2">Â¥${product.price}</span>
            </div>
        `;
        container.appendChild(item);
    });
}

// åˆ·æ–°å…¨éƒ¨æ•°æ®
function refreshAll() {
    const refreshBtn = document.querySelector('#refreshIcon');
    refreshBtn.style.transform = 'rotate(360deg)';
    refreshBtn.style.transition = 'transform 0.5s';

    showMessage('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');

    // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®å’Œå›¾è¡¨
    updateDataTime();
    loadStatistics();
    loadCategoryChart();
    loadPriceChart();
    loadTrendChart();
    loadHotProducts();

    setTimeout(() => {
        refreshBtn.style.transform = 'rotate(0deg)';
        showMessage('æ•°æ®åˆ·æ–°å®Œæˆï¼', 'success');
    }, 500);
}

// æ·»åŠ ä¸€ä¸ªAPIè°ƒç”¨ç»Ÿè®¡æ•°æ®çš„å‡½æ•°ï¼ˆéœ€è¦åç«¯æ”¯æŒï¼‰
function getPlatformStats() {
    // è¿™é‡Œå¯ä»¥è°ƒç”¨ä¸€ä¸ªæ–°çš„APIç«¯ç‚¹æ¥è·å–å¹³å°ç»Ÿè®¡æ•°æ®
    // ä¾‹å¦‚ï¼š/api/stats
    // è¿”å›æ ¼å¼ï¼š
    // {
    //   active_products: 85,
    //   total_orders: 156,
    //   total_favorites: 245,
    //   active_users: 42,
    //   today_changes: {
    //     products: 5,
    //     orders: 3,
    //     favorites: 12,
    //     users: 2
    //   }
    // }

    // æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®
    return {
        active_products: 85,
        total_orders: 156,
        total_favorites: 245,
        active_users: 42,
        today_changes: {
            products: 5,
            orders: 3,
            favorites: 12,
            users: 2
        }
    };
}
</script>
</body>
</html>